<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script type="text/javascript">
    google.load("visualization", "1", {packages: ['corechart', 'bar']});
    google.setOnLoadCallback(drawTopicsChart);
    google.setOnLoadCallback(drawDisciplinesChart);

    var activeTab;
    function getChart(activeTab) {
        if (activeTab == "chart-tab") {
            document.getElementById('charts').style.display = 'block';
            document.getElementById('map').style.display = 'none';
            drawTopicsChart();
            drawDisciplinesChart();
        }
        else {
            document.getElementById('charts').style.display = 'none';
            document.getElementById('map').style.display = 'block';
        }
    }

    function drawTopicsChart() {
        var raw_data = {{ topic_counts|safe }};
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Topic');
        data.addColumn('number', 'Count');

        data.addRows([
            {% for row in topic_counts %}
                ['{{ row.name }}'.replace(/&amp;/g, '&'), {{ row.count }}]{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]);
        data.sort([{column: 1, desc: true}]);
        var max_value = data.getColumnRange(1).max;

        var chartHeight = data.getNumberOfRows() * 25 + 80;

        var tick_count;
        if (max_value <= 10) {
            tick_count = max_value + 1;
        }
        else {
            tick_count = 6
        }

        var options = {
            title: "Summary by Topic",
            height: chartHeight,
            hAxis: {
                viewWindow: {
                    min: 0,
                    max: max_value
                },
                format: '0',
                gridlines: {
                    count: tick_count
                }
            },
            legend: {
                position: 'none'
            },
            chartArea: {
                left: '27%',
                right: '5%',
                top: 25,
                bottom: 25
            },
            series: {
                0:{color: '#6BBC49'}
            }
        };
        var chart = new google.visualization.BarChart(document.getElementById('by_topic'));
        chart.draw(data, options);

        var rowNum;
        function selectHandler(e) {
            rowNum = chart.getSelection()[0]['row'];
            window.location = raw_data[rowNum]['link'];
        }

        google.visualization.events.addListener(chart, 'select', selectHandler);
    }


    function drawDisciplinesChart() {
        var raw_data = {{ discipline_counts|safe }};
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Discipline');
        data.addColumn('number', 'Count');

        data.addRows([
            {% for row in discipline_counts %}
                ['{{ row.name }}'.replace(/&amp;/g, '&'), {{ row.count }}]{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]);
        data.sort([{column: 1, desc: true}]);
        var max_value = data.getColumnRange(1).max;

        var chartHeight = data.getNumberOfRows() * 25 + 80;

        var tick_count;
        if (max_value <= 10) {
            tick_count = max_value + 1;
        }
        else {
            tick_count = 6
        }

        var options = {
            title: "Summary by Discipline",
            height: chartHeight,
            hAxis: {
                viewWindow: {
                    min: 0,
                    max: max_value
                },
                format: '0',
                gridlines: {
                    count: tick_count
                }
            },
            legend: {
                position: 'none'
            },
            chartArea: {
                left: '27%',
                right: '5%',
                top: 25,
                bottom: 25
            },
            series: {
                0:{color: '#6BBC49'}
            }
        };
        var chart = new google.visualization.BarChart(document.getElementById('by_discipline'));
        chart.draw(data, options);

        var rowNum;
        function selectHandler(e) {
            rowNum = chart.getSelection()[0]['row'];
            window.location = raw_data[rowNum]['link'];
        }

        google.visualization.events.addListener(chart, 'select', selectHandler);
    }

    function drawInstallationsChart() {
        var raw_data = {{ installation_counts|safe }};
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Discipline');
        data.addColumn('number', 'Count');

        data.addRows([
            {% for row in installation_counts %}
                ['{{ row.name }}'.replace(/&amp;/g, '&'), {{ row.count }}]{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]);
        data.sort([{column: 1, desc: true}]);
        var max_value = data.getColumnRange(1).max;

        var chartHeight = data.getNumberOfRows() * 25 + 80;

        var tick_count;
        if (max_value <= 10) {
            tick_count = max_value + 1;
        }
        else {
            tick_count = 6
        }

        var options = {
            title: "Summary by Installation",
            height: chartHeight,
            hAxis: {
                viewWindow: {
                    min: 0,
                    max: max_value
                },
                format: '0',
                gridlines: {
                    count: tick_count
                }
            },
            legend: {
                position: 'none'
            },
            chartArea: {
                left: '27%',
                right: '5%',
                top: 25,
                bottom: 25
            },
            series: {
                0:{color: '#6BBC49'}
            }
        };
        var chart = new google.visualization.BarChart(document.getElementById('by_installation'));
        chart.draw(data, options);

        var rowNum;
        function selectHandler(e) {
            rowNum = chart.getSelection()[0]['row'];
            window.location = raw_data[rowNum]['link'];
        }

        google.visualization.events.addListener(chart, 'select', selectHandler);
    }
</script>
